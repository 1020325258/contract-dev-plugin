---
name: test-driven-development
description: 测试驱动开发规范，在开发新逻辑之前必须阅读此规范，先生成测试。
---

## ✅ 测试驱动开发 (TDD)（CRITICAL）

> [!CAUTION]
> **任何代码变更必须遵循 Red → Green → Refactor，并且提交中必须包含对应测试。**

### 流程（必须按顺序）

1. **Red：先写测试**

   * 新增能力/修复 Bug 前，先补充或新增测试用例
   * 测试应能稳定复现问题（修 Bug 时必须先写“回归测试”）
2. **Green：最小实现通过测试**

   * 只写让测试通过的最小改动，避免顺手重构/扩功能
3. **Refactor：重构但不改行为**

   * 在**测试全绿**前提下再做结构优化、抽方法、改命名等

### 规则（必须遵守）

- **新逻辑必有测试**：新增/改动的分支逻辑必须覆盖关键路径与边界条件
- **回归优先**：任何线上/灰度问题，必须先补测试锁住，再修代码
- **分层测试策略**：
  * 领域/业务逻辑：优先 **单元测试**（快、稳定、定位准）
  * RPC/DB/外部依赖：用 **契约/集成测试** 覆盖关键链路（少而精）
- **Mock 使用约束**：
  * 只 Mock 外部依赖（RPC/DB/第三方），不要 Mock 被测对象内部实现细节
  * Mock 行为要“像真实一样”，避免过度宽松导致测试失真
- **断言要有意义**：不仅断言“非空/不报错”，必须断言**关键业务输出/状态变化/副作用**
- **测试不可脆弱**：避免依赖随机数、当前时间、执行顺序、环境差异；必要时注入时钟/随机源

### 交付标准

- 本次变更相关测试 **全绿**，且新增测试能解释“改动原因与预期行为”
- 如测试难写，优先重构代码使其 **可测试**（依赖注入、纯函数化、拆分副作用）
